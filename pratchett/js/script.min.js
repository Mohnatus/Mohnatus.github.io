"use strict";(function(){var r=function(t){var e=document.querySelector(t),i=(e.querySelector(t+"__close"),e.hasAttribute("data-close"));e.addEventListener("click",function(t){t.stopPropagation(),i?(i=!1,e.removeAttribute("data-close")):(i=!0,e.setAttribute("data-close",""))})};window.dataLayer=window.dataLayer||[];var o=function(t){dataLayer.push({ecommerce:{currencyCode:"RUB",add:{products:[{name:t.name,id:t.id,price:t.price,quantity:1}]}},event:"gtm-ee-event","gtm-ee-event-category":"Enhanced Ecommerce","gtm-ee-event-action":"Adding a Product to a Shopping Cart","gtm-ee-event-non-interaction":"False"})},i=function(t){console.log(t.callback),dataLayer.push({ecommerce:{currencyCode:"RUB",click:{actionField:{list:"Терри Пратчетт"},products:[{name:t.name,id:t.id,price:t.price}]}},event:"gtm-ee-event","gtm-ee-event-category":"Enhanced Ecommerce","gtm-ee-event-action":"Product Clicks","gtm-ee-event-non-interaction":"False"}),t.callback&&t.callback()},e={inited:!1,$:null,link:null,img:null,title:null,author:null,publisherBlock:null,publisher:null,priceBlock:null,price:null,buttonBlock:null,rating:null,ratingCount:null,ratingVote:null,yearBlock:null,year:null,description:null,selectors:{link:".book-card__img",img:"img",title:".book-card__title",author:".book-card__author",publisherBlock:".book-card__publisher",publisher:".publisher",priceBlock:".book-card__price",price:".price",buttonBlock:".book-card__button",rating:".book-rating",ratingCount:".count",ratingVote:".vote",yearBlock:".book-card__year",year:".year",description:".book-card__annotation"},init:function(t){this.inited||(this.$=t.element,this.link=this.$.querySelector(e.selectors.link),this.img=this.link.querySelector(e.selectors.img),this.title=this.$.querySelector(e.selectors.title),this.author=this.$.querySelector(e.selectors.author),this.publisherBlock=this.$.querySelector(e.selectors.publisherBlock),this.publisher=this.publisherBlock.querySelector(e.selectors.publisher),this.priceBlock=this.$.querySelector(e.selectors.priceBlock),this.price=this.priceBlock.querySelector(e.selectors.price),this.buttonBlock=this.$.querySelector(e.selectors.buttonBlock),this.rating=this.$.querySelector(e.selectors.rating),this.ratingCount=this.rating.querySelector(e.selectors.ratingCount),this.ratingVote=this.rating.querySelector(e.selectors.ratingVote),this.ratingVote=this.rating.querySelector(e.selectors.ratingVote),this.yearBlock=this.$.querySelector(e.selectors.yearBlock),this.year=this.yearBlock.querySelector(e.selectors.year),this.description=this.$.querySelector(e.selectors.description),this.link.addEventListener("click",this.clickHandler.bind(this)),this.title.addEventListener("click",this.clickHandler.bind(this)),this.inited=!0)},clickHandler:function(t){var e=this;console.log(this.link),t.preventDefault(),i({id:this.$.getAttribute("data-element"),name:this.title.innerHTML,price:this.price.textContent,callback:function(){window.location.href=e.link.href}})},setImage:function(t){this.img.setAttribute("src",t)},setLink:function(t){this.link.setAttribute("href",t)},setTitle:function(t){this.title.textContent=t},setAuthor:function(t){t?(this.author.textContent=t,this.author.style.display="block"):this.author.style.display="none"},setRating:function(t,e){t=t||0,e=e||0,this.ratingCount.textContent=t,this.ratingVote.textContent=e},setYear:function(t){t?(this.year.textContent=t,this.yearBlock.style.display="inline"):this.yearBlock.style.display="none"},setPublisher:function(t){t?(this.publisher.textContent=t,this.publisherBlock.style.display="inline"):this.publisherBlock.style.display="none"},setPrice:function(t){this.price.textContent=t},setId:function(t){this.$.setAttribute("data-element",t)},setButton:function(i){var n=this;this.buttonBlock.innerHTML=i.button;var s=this.buttonBlock.querySelector("button");s&&s.addEventListener("click",function(t){var e=s.getAttribute("data-status");if("buy"==e){s.getAttribute("data-product");window.add2Basket(s,function(){i.button=n.buttonBlock.innerHTML,o({id:i.id,name:i.title,price:i.price}),VK.Retargeting.Event("button_buy")})}else"in-basket"==e&&(window.location.href="/personal/basket.php")})},setDescription:function(t){this.description.innerHTML=t},setData:function(t){this.setLink(t.link),this.setImage(t.img),this.setTitle(t.title),this.setAuthor(t.author),this.setRating(t.rating,t.votes),this.setYear(t.year),this.setPublisher(t.publisher),this.setPrice(t.price),this.setDescription(t.description),this.setId(t.id),this.setButton(t)}},n={inited:!1,$:null,prev:null,next:null,$slidesContainer:null,slides:[],viewed:5,center:null,leftDiff:null,leftLimit:null,currentSlide:null,currentSlideIndex:null,currentLeftIndex:null,activeAttr:"data-active",slideAttr:"data-slide",mainAttr:"",onChange:null,reset:!1,hideNext:!1,hidePrev:!1,selectors:{prev:"[data-prev]",next:"[data-next]",slides:"[data-slides]"},init:function(t){this.inited||(this.$=t.element,this.prev=this.$.querySelector(n.selectors.prev),this.next=this.$.querySelector(n.selectors.next),this.prev.addEventListener("click",this.toPrevSlide.bind(this)),this.next.addEventListener("click",this.toNextSlide.bind(this)),this.$slidesContainer=this.$.querySelector(n.selectors.slides),this.viewed=t.viewed||this.viewed,this.center=t.center,this.leftDiff=this.center-1,this.mainAttr=t.attr,this.onChange=t.onChange,this.inited=!0)},update:function(){this.slides=[];var t=Array.prototype.slice.call(this.$slidesContainer.children);this.handleSlides(t),t.length<=this.viewed?this.reset||this.resetSlider():(this.reset&&this.setSlider(),this.leftLimit=this.slides.length-this.viewed)},handleSlides:function(t){var n=this;t.forEach(function(t,e){t.setAttribute(n.slideAttr,e),t.querySelector("[data-index]").setAttribute("data-index",e+1),t.addEventListener("click",function(){return n.handleClick(e)});var i=t.dataset;console.log(i),n.slides.push({$:t,index:e,data:i})}),this.leftLimit=this.slides.length-this.viewed},setActive:function(t,e){t=t||0,this.currentSlide&&this.currentSlide.removeAttribute(this.activeAttr);var i=void 0;if(e){var n=this.$slidesContainer.querySelector("[data-"+e+'="'+t+'"]');console.log(n),i=this.slides[n.getAttribute(this.slideAttr)].$}else i=this.slides[t].$;this.currentSlide=i,this.currentSlideIndex=t,this.currentSlide.setAttribute(this.activeAttr,""),this.setCenterSlide(),this.handleControls()},handleControls:function(){0==this.currentSlideIndex?this.hidePrevControl():this.hidePrev&&this.showPrevControl(),this.currentSlideIndex==this.slides.length-1?this.hideNextControl():this.hideNext&&this.showNextControl()},setCenterSlide:function(){if(this.reset)return this.currentLeftIndex=0,void this.move(0);var t=this.$slidesContainer.getBoundingClientRect().left,e=this.countLeftSlide(this.currentSlideIndex);this.currentLeftIndex=e.index;var i=Math.floor(e.$.getBoundingClientRect().left-t);this.move(i)},countLeftSlide:function(t){(!t||t<0)&&(t=0);var e=this.isCenter?0:t;return t>this.leftDiff&&(e=t-this.leftDiff),e>this.leftLimit&&(e=this.leftLimit),this.slides[e]},move:function(t){this.$slidesContainer.style.left=-1*t+"px"},toPrevSlide:function(){var t=Math.max(this.currentSlideIndex-1,0);this.toSlide(t)},toNextSlide:function(){var t=Math.min(this.currentSlideIndex+1,this.slides.length-1);this.toSlide(t)},toSlide:function(t){console.log(this.slides[t]),this.setActive(t),this.onChange(this.slides[t].data)},handleClick:function(t){this.toSlide(t)},resetSlider:function(){this.$.setAttribute("data-no-slider",""),this.prev=this.$.removeChild(this.prev),this.next=this.$.removeChild(this.next),this.reset=!0},hidePrevControl:function(){this.prev.setAttribute("data-inactive",""),this.hidePrev=!0},hideNextControl:function(){this.next.setAttribute("data-inactive",""),this.hideNext=!0},showPrevControl:function(){this.prev.removeAttribute("data-inactive"),this.hidePrev=!1},showNextControl:function(){this.next.removeAttribute("data-inactive"),this.hideNext=!1},setSlider:function(){this.$.removeAttribute("data-no-slider"),this.$.insertBefore(this.prev,this.$.children[0]),this.$.insertBefore(this.next,null),this.reset=!1},moveOn:function(){this.$.setAttribute("data-move","")},moveOff:function(){this.$.removeAttribute("data-move")}},t={$:null,close:null,controls:null,seria:null,bookCard:e,controlsSlider:n,sets:{},currentSet:null,tagText:"",showAttr:"data-shown",controlClass:"pratchett-control",controlBookAttr:"view",controlVarAttr:"var",init:function(t){var e=this;this.$=t.element,this.close=this.$.querySelector("[data-close]"),this.close.addEventListener("click",function(){return e.hideCard()}),document.addEventListener("click",function(t){e.isOpen&&!e.$.contains(t.target)&&e.hideCard()}),this.$bookCard=this.$.querySelector(t.bookCard),this.bookCard.init({element:this.$bookCard}),this.seria=this.$.querySelector(t.seria),this.tagText=t.tagText||this.tagText;var i=this.$.querySelector(t.controls);this.controls=i.querySelector("[data-slides]"),this.controlsSlider.init({viewed:4,center:1,element:i,onChange:function(t){return e.controlChange(t)},attr:this.controlBookAttr})},update:function(t){this.setSeria(t.cycleName),this.$.setAttribute("data-cycle",t.cycle),this.controlsSlider.moveOff(),this.sets[t.cycle]||this.createSet(t.slides,t.cycle),this.restoreSet(t.cycle),this.activateElement(t.cycle,t.index,0),this.showCard(),this.controlsSlider.moveOn()},setSeria:function(t){t?this.$.setAttribute("data-seria",t):this.$.removeAttribute("data-seria"),this.seria.textContent=t?"цикла «"+t+"»":"Терри Пратчетта"},createSet:function(t,e){var i=this.createControls(t);this.sets[e]={items:t,$controls:i.fragment,controls:i.items}},createControls:function(e){var s=this,r=document.createDocumentFragment(),o=[];console.log("controls",e);for(var t=function(n,t){e[n].forEach(function(t,e){var i=s.createControl(t,n,e);o.push(i),r.appendChild(i)})},i=0,n=e.length;i<n;i++)t(i);return{fragment:r,items:o}},createControl:function(t,e,i){var n=document.createElement("div");n.classList.add(this.controlClass),n.setAttribute("data-"+this.controlBookAttr,e),n.setAttribute("data-"+this.controlVarAttr,i);var s=document.createElement("div");s.classList.add(this.controlClass+"__img"),s.innerHTML="<img src="+t.img+'><div class="tag" data-index data-cycle-bg>'+this.tagText+"</div>";var r=document.createElement("div");return r.innerHTML=t.title,r.classList.add(this.controlClass+"__title"),n.appendChild(s),n.appendChild(r),n},restoreSet:function(t){this.currentSet=t;var e=this.sets[t].$controls.cloneNode(!0);this.setControls(e)},setControls:function(t){this.controls.innerHTML="",this.controls.appendChild(t),this.controlsSlider.update()},controlChange:function(t){console.log("card",t),this.updateCard(this.currentSet,t[this.controlBookAttr],t[this.controlVarAttr])},activateElement:function(t,e,i){this.updateCard(t,e,i),this.controlsSlider.setActive(e,this.controlAttr)},updateCard:function(t,e,i){console.log("update card",e,i),i=i||0;var n=this.sets[t].items[e][i];this.bookCard.setData(n)},showCard:function(){this.isOpen||(this.$.setAttribute(this.showAttr,""),this.isOpen=!0)},hideCard:function(){this.isOpen&&(this.$.removeAttribute(this.showAttr),this.isOpen=!1)}},l=t,s=document.querySelector(".turtle"),c=document.querySelector(".pratchett-scheme"),a={},h=void 0,d=function(){h&&(s.removeChild(h),h=null)},u={show:function(t,e){if(d(),a[t]||(a[t]={}),!a[t][e]){var i=c.querySelector('.book[data-cycle="'+t+'"][data-index="'+e+'"]');a[t][e]=i?i.cloneNode(!0):-1}-1!=a[t][e]&&(h=a[t][e],s.appendChild(h))},hide:d},f={slow:20,normal:50,fast:100},v=10;var m=function(t,e){var i=self.pageYOffset?self.pageYOffset:document.documentElement&&document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0,n=function(t){for(var e=document.getElementById(t),i=e.offsetTop,n=e;n.offsetParent&&n.offsetParent!=document.body;)i+=(n=n.offsetParent).offsetTop;return i}(t),s=i<n?n-i:i-n;if(s<100)scrollTo(0,n);else{var r=f[e=e||"normal"]||20,o=Math.round(s/r),l=Math.round(s/v),c=i<n?i+l:i-l,a=0;if(i<n)for(var h=i;h<n;h+=l)setTimeout("window.scrollTo(0, "+c+")",a*o),n<(c+=l)&&(c=n),a++;else for(h=i;n<h;h-=l)setTimeout("window.scrollTo(0, "+c+")",a*o),(c-=l)<n&&(c=n),a++}},p=window.pratchettData;window.add2Basket=function(t,e){t.setAttribute("data-status","in-basket"),t.textContent="В корзине",e&&e()},window.addEventListener("DOMContentLoaded",function(){r(".pratchett-map");var t=document.querySelector(".turtle").querySelectorAll(".flag"),e=Array.prototype.slice.call(document.querySelectorAll("[data-cycle-item]"),this);window.label=u;for(var i=0,n=t.length;i<n;i++)t[i].addEventListener("mouseenter",function(t){var e=this.dataset.cycle,i=this.dataset.index;u.show(e,i)}),t[i].addEventListener("mouseleave",function(t){u.hide()});l.init({element:document.querySelector(".pratchett-card"),bookCard:".book-card",controls:'[data-slider="pratchett"]',seria:".seria",tagText:""}),e.forEach(function(o,t){o.addEventListener("click",function(t){t.stopPropagation();var e=o,i=e.dataset.cycle,n=e.dataset.index-1,s=p[i].items,r=p[i].name;l.update({slides:s,cycle:i,cycleName:r,index:n})})});var s=document.querySelector(".compass");s.addEventListener("click",function(){m("scheme-scroll","slow")})})}).call(void 0);